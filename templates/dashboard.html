{% extends "layout.html" %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-8">
    <div class="card p-3 card-hero">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-0">Your Dashboard — {{ tier }} tier</h4>
          <div class="small-muted">Alerts left today: <strong id="alerts-left">{{ remaining_alerts }}</strong></div>
        </div>
        <div class="text-end">
          <input id="search-symbol" class="form-control form-control-sm" placeholder="Search symbol e.g. NVDA" style="width:200px; display:inline-block;">
          <button class="btn btn-sm btn-primary" onclick="checkSymbol()">Check</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="refreshWatchlist()">Refresh</button>
        </div>
      </div>

      <hr>
      <div id="watchlist-area" class="mb-3">
        <h6>Watchlist</h6>
        <div id="watchlist-cards" class="row gy-3"></div>
      </div>

      <div class="mt-3">
        <h6>Alerts History</h6>
        <ul id="alerts-history" class="list-group"></ul>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card p-3 card-hero">
      <h6>Quick Add</h6>
      <div class="input-group mb-2">
        <input id="add-symbol" class="form-control form-control-sm" placeholder="Symbol (e.g. AAPL)">
        <button class="btn btn-success btn-sm" onclick="addWatch()">Add</button>
      </div>
      <div class="small-muted mb-3">Watchlist slots depend on your tier.</div>

      <h6 class="mt-3">Top Discounts</h6>
      <div id="top-discounts" class="list-group"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function checkSymbol(){
  const sym = document.getElementById('search-symbol').value.trim().toUpperCase();
  if(!sym) return alert('Enter symbol');
  const res = await fetch('/api/check_symbol', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({symbol: sym})
  });
  const j = await res.json();
  if(res.ok) {
    showModalSymbol(j);
    refreshWatchlist();
    loadAlerts();
    updateAlertsLeft();
  } else {
    alert(j.error || j.alert_message || 'Error');
  }
}

function showModalSymbol(data){
  let html = `<div class="mb-2"><strong>${data.symbol}</strong> — $${Number(data.price).toFixed(2)}</div>
              <div class="small-muted">30d high: $${Number(data['30d_high']).toFixed(2)}</div>
              <div class="mt-2">Discount: <span class="badge bg-${data.discount_percent>=5 ? 'success':'secondary'}">${data.discount_percent}%</span></div>
              <div class="mt-2"><a target="_blank" href="https://finance.yahoo.com/quote/${data.symbol}">View on Yahoo Finance</a></div>`;
  const win = window.open("", "_blank", "width=600,height=400");
  win.document.write(`<html><head><title>${data.symbol}</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"></head><body class="p-3">${html}</body></html>`);
}

async function addWatch(){
  const symbol = document.getElementById('add-symbol').value.trim().toUpperCase();
  if(!symbol) return alert('Enter a symbol');
  const res = await fetch('/api/add_watchlist', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({symbol})
  });
  const j = await res.json();
  if(res.ok) {
    document.getElementById('add-symbol').value='';
    refreshWatchlist();
  } else {
    alert(j.error || 'Error adding');
  }
}

async function removeWatch(symbol){
  await fetch('/api/remove_watchlist', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({symbol})
  });
  refreshWatchlist();
}

async function refreshWatchlist(){
  const res = await fetch('/api/get_watchlist_data');
  if(!res.ok) return;
  const j = await res.json();
  const wrap = document.getElementById('watchlist-cards');
  wrap.innerHTML='';
  const arr = j.watchlist || [];
  // top discounts fill right panel
  const top = arr.slice().sort((a,b)=>b.discount_percent - a.discount_percent).slice(0,5);
  const topWrap = document.getElementById('top-discounts');
  topWrap.innerHTML = "";
  top.forEach(t=>{
    topWrap.innerHTML += `<a class="list-group-item list-group-item-action" href="#" onclick="showModalSymbol(${JSON.stringify(t)})">
      <div class="d-flex justify-content-between"><div>${t.symbol}</div><div><span class="badge bg-success">${t.discount_percent}%</span></div></div>
    </a>`;
  });

  arr.forEach(item=>{
    const id = `chart-${item.symbol}`;
    const card = document.createElement('div');
    card.className='col-md-6';
    card.innerHTML = `
      <div class="card p-2">
        <div class="d-flex justify-content-between">
          <div><span class="ticker">${item.symbol}</span><div class="small-muted">Price $${Number(item.price).toFixed(2)}</div></div>
          <div class="text-end">
            <div class="discount-badge"> ${item.discount_percent}%</div>
            <div class="small-muted"><button class="btn btn-sm btn-outline-danger" onclick="removeWatch('${item.symbol}')">Remove</button></div>
          </div>
        </div>
        <div class="chart-card mt-2"><canvas id="${id}"></canvas></div>
      </div>`;
    wrap.appendChild(card);

    // create chart after insertion
    setTimeout(()=> {
      try {
        const ctx = document.getElementById(id).getContext('2d');
        new Chart(ctx, {
          type:'line',
          data: {
            labels: item.dates,
            datasets: [{
              label: item.symbol,
              data: item.closes,
              tension:0.3,
              pointRadius:0,
              fill:true
            }]
          },
          options: { plugins:{legend:{display:false}}, scales:{x:{display:false}} }
        });
      } catch(e){ console.error(e); }
    }, 100);
  });
}

async function loadAlerts(){
  const res = await fetch('/api/alerts_history');
  const j = await res.json();
  const el = document.getElementById('alerts-history');
  el.innerHTML = "";
  j.alerts.forEach(a=>{
    el.innerHTML += `<li class="list-group-item">${a.timestamp.split('.')[0]} — <strong>${a.symbol}</strong> ${a.discount}%</li>`;
  });
}

async function updateAlertsLeft(){
  const left = document.getElementById('alerts-left');
  // we reload dashboard to get the fresh value — at this stage call endpoint that re-renders remaining might be added later
  // quick hack: re-fetch alerts count client-side
  const resp = await fetch('/api/alerts_history');
  const j = await resp.json();
  // can't reliably compute daily limit here (we show server-side initial). We'll just refresh page when necessary.
}

document.addEventListener('DOMContentLoaded', function(){
  refreshWatchlist();
  loadAlerts();
});
</script>
{% endblock %}
